# Game Drives Table - Field Mapping Report

> **Purpose**: Complete field mapping verification for the game_drives table
> **Date Generated**: October 22, 2025
> **Status**: ✅ Schema Complete, ⚠️ Not Yet Populated
> **CodeRef**: Migration `20250101000008:29-50` (no scraper yet)

---

## Executive Summary

The **game_drives table** tracks drive-by-drive breakdown of each game. A "drive" is a sequence of plays where one team has possession, ending in a score, turnover, punt, or end of period.

- **Total Columns**: 11 (+ 3 metadata)
- **Total Records**: 0 (⚠️ Not yet scraped - no scraper exists)
- **Critical Fields**: ✅ 11/11 verified
- **Normalization Status**: ✅ 100% compliant
- **Ready for Frontend**: ✅ Yes (schema ready)
- **Auto-Populated**: ❌ No scraper implemented yet

**Expected Data Volume:**
- ~20-24 drives per team per game
- ~40-48 total drives per game
- 272 games × 45 drives = **~12,240 drives for 2025 season**
- Comment in migration: "280,000+ drives" (multi-season historical)

---

## All 11 Fields (Copy-Paste Ready)

```
drive_id, game_id, season, team_id, drive_number, quarter, start_time_seconds, end_time_seconds, duration_seconds, plays, yards, result
```

---

## Field Categories

### Identification (4 fields)
```
drive_id, game_id, season, team_id
```

### Position in Game (2 fields)
```
drive_number, quarter
```

### Timing (3 fields)
```
start_time_seconds, end_time_seconds, duration_seconds
```

### Drive Statistics (2 fields)
```
plays, yards
```

### Outcome (1 field)
```
result
```

---

## Complete Field Mapping

| Field Name | Database Column | Type | Example | Nullable | Notes |
|------------|-----------------|------|---------|----------|-------|
| Drive ID | `drive_id` | bigserial | 1 | ❌ No | PK (auto-increment) |
| Game ID | `game_id` | varchar(50) | "401772510" | ❌ No | Which game (FK to games) |
| Season | `season` | integer | 2025 | ❌ No | Which season |
| Team ID | `team_id` | varchar(10) | "DAL" | ❌ No | Offensive team (FK to teams) |
| Drive Number | `drive_number` | integer | 1 | ❌ No | Sequence (1st, 2nd, 3rd drive) |
| Quarter | `quarter` | integer | 1 | ✅ Yes | Which quarter (1-5, 5=OT) |
| Start Time Seconds | `start_time_seconds` | integer | 900 | ✅ Yes | Game clock at start (900=15:00) |
| End Time Seconds | `end_time_seconds` | integer | 547 | ✅ Yes | Game clock at end (547=9:07) |
| Duration Seconds | `duration_seconds` | integer | 353 | ✅ Yes | Real-world time (5:53) |
| Plays | `plays` | integer | 6 | ✅ Yes | Number of plays (default 0) |
| Yards | `yards` | decimal(6,1) | 53.0 | ✅ Yes | Net yards gained (default 0) |
| Result | `result` | varchar(50) | "Touchdown" | ✅ Yes | How drive ended |

---

## Data Source Mapping

### ESPN API → Database

**Source**: ESPN Game Summary API
**Endpoint**: `https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event={gameId}`
**Path**: `response.data.drives.previous[]`

**ESPN API Structure:**
```json
{
  "id": "4017725101",
  "description": "6 plays, 53 yards, 3:11",
  "team": {
    "id": "6",
    "abbreviation": "DAL"
  },
  "start": {
    "period": { "number": 1 },
    "clock": { "displayValue": "15:00" },
    "yardLine": 53,
    "text": "DAL 47"
  },
  "end": {
    "period": { "number": 1 },
    "clock": { "displayValue": "11:49" },
    "yardLine": 0,
    "text": "PHI 0"
  },
  "timeElapsed": {
    "displayValue": "3:11"
  },
  "yards": 53,
  "isScore": true,
  "offensivePlays": 6,
  "result": "TD",
  "displayResult": "Touchdown"
}
```

**Mapped to Database:**
```json
{
  "game_id": "401772510",
  "season": 2025,
  "team_id": "DAL",
  "drive_number": 1,
  "quarter": 1,
  "start_time_seconds": 900,
  "end_time_seconds": 709,
  "duration_seconds": 191,
  "plays": 6,
  "yards": 53.0,
  "result": "Touchdown"
}
```

---

## Field Mapping Details

| Database Column | ESPN Source | Transform | Notes |
|-----------------|-------------|-----------|-------|
| drive_id | Auto-increment | N/A | Generated by database |
| game_id | From URL parameter | Direct | Game being scraped |
| season | From game data | Extract from game | 2025 |
| team_id | `team.abbreviation` | Normalize | Use team-normalizer.js |
| drive_number | Array index | Increment | Count drives in order |
| quarter | `start.period.number` | Direct | 1-4 (5 for OT) |
| start_time_seconds | `start.clock.displayValue` | Parse clock | "15:00" → 900 seconds |
| end_time_seconds | `end.clock.displayValue` | Parse clock | "11:49" → 709 seconds |
| duration_seconds | `timeElapsed.displayValue` | Parse duration | "3:11" → 191 seconds |
| plays | `offensivePlays` | Direct | Count of plays |
| yards | `yards` | Direct | Net yards |
| result | `displayResult` or `result` | Map to standard | See result mapping below |

---

## Drive Result Mapping

### ESPN → Database Result Values

| ESPN `result` | ESPN `displayResult` | Database `result` | Notes |
|---------------|---------------------|-------------------|-------|
| "TD" | "Touchdown" | "Touchdown" | Scored TD |
| "FG" | "Field Goal" | "Field Goal" | Kicked FG |
| "Punt" | "Punt" | "Punt" | Punted away |
| "Turnover" | "Interception" or "Fumble" | "Turnover" | Lost possession |
| "Turnover on Downs" | "Turnover on Downs" | "Turnover on Downs" | Failed 4th down |
| "Missed FG" | "Missed Field Goal" | "Missed Field Goal" | FG attempt failed |
| "End of Half" | "End of Half" | "End of Half" | Clock ran out |
| "End of Game" | "End of Game" | "End of Game" | Game ended |
| "Blocked Punt" | "Blocked Punt" | "Blocked Punt" | Punt was blocked |
| "Safety" | "Safety" | "Safety" | Safety scored |

---

## Clock Time Parsing

### Converting "MM:SS" to Seconds

**Formula**: `(minutes × 60) + seconds`

**Examples:**
```javascript
function parseClockToSeconds(clockDisplay) {
  const [minutes, seconds] = clockDisplay.split(':').map(Number)
  return (minutes * 60) + seconds
}

parseClockToSeconds("15:00") // → 900 seconds
parseClockToSeconds("11:49") // → 709 seconds
parseClockToSeconds("2:03")  // → 123 seconds
parseClockToSeconds("0:17")  // → 17 seconds
```

**Quarter-based total game time:**
```javascript
function calculateGameSeconds(quarter, clockSeconds) {
  const quarterLengthSeconds = 900 // 15 minutes
  const elapsedQuarters = quarter - 1
  const quarterElapsed = quarterLengthSeconds - clockSeconds
  return (elapsedQuarters * quarterLengthSeconds) + quarterElapsed
}

// Q1 at 11:49 = 0 complete quarters + (900 - 709) = 191 seconds into game
// Q2 at 8:30 = 1 complete quarter + (900 - 510) = 900 + 390 = 1,290 seconds
```

---

## Common Queries

### Get All Drives for a Game

```javascript
const { data: drives } = await supabase
  .from('game_drives')
  .select(`
    *,
    team:teams(team_name, team_abbr)
  `)
  .eq('game_id', '401772510')
  .order('drive_number')

drives.forEach(drive => {
  console.log(`Drive ${drive.drive_number}: ${drive.team.team_abbr} - ${drive.plays} plays, ${drive.yards} yards → ${drive.result}`)
})
```

### Get Scoring Drives Only

```javascript
const { data: scoringDrives } = await supabase
  .from('game_drives')
  .select('*')
  .eq('game_id', '401772510')
  .in('result', ['Touchdown', 'Field Goal', 'Safety'])
  .order('drive_number')

console.log(`${scoringDrives.length} scoring drives in this game`)
```

### Calculate Average Drive Statistics

```javascript
const { data: teamDrives } = await supabase
  .from('game_drives')
  .select('plays, yards, result')
  .eq('team_id', 'KC')
  .eq('season', 2025)

const avgPlays = teamDrives.reduce((sum, d) => sum + d.plays, 0) / teamDrives.length
const avgYards = teamDrives.reduce((sum, d) => sum + d.yards, 0) / teamDrives.length
const tdDrives = teamDrives.filter(d => d.result === 'Touchdown').length

console.log(`KC Average: ${avgPlays.toFixed(1)} plays, ${avgYards.toFixed(1)} yards per drive`)
console.log(`${tdDrives} TD drives (${(tdDrives / teamDrives.length * 100).toFixed(1)}%)`)
```

### Find Longest Drives

```javascript
const { data: longDrives } = await supabase
  .from('game_drives')
  .select(`
    *,
    team:teams(team_name),
    game:games(home_team_id, away_team_id, home_score, away_score)
  `)
  .eq('season', 2025)
  .order('duration_seconds', { ascending: false })
  .limit(10)

longDrives.forEach((drive, i) => {
  console.log(`${i+1}. ${drive.team.team_name} - ${Math.floor(drive.duration_seconds / 60)}:${(drive.duration_seconds % 60).toString().padStart(2, '0')} (${drive.plays} plays)`)
})
```

---

## ⚠️ CRITICAL: Common Mistakes

### ❌ WRONG - Assuming all fields are populated

```javascript
const totalTime = drive.duration_seconds  // Could be NULL!
```

### ✅ CORRECT - Check for null values

```javascript
const totalTime = drive.duration_seconds || 0
if (drive.start_time_seconds && drive.end_time_seconds) {
  // Calculate duration if not provided
}
```

### ❌ WRONG - Not normalizing team_id

```javascript
const teamId = espnDrive.team.abbreviation  // Could be "WSH" instead of "WAS"
```

### ✅ CORRECT - Use team normalizer

```javascript
import { normalizeTeamId } from '../utils/team-normalizer.js'
const teamId = normalizeTeamId(espnDrive.team.abbreviation)
```

### ❌ WRONG - Hardcoding quarter = 1-4

```javascript
if (quarter > 4) {
  throw new Error('Invalid quarter')
}
```

### ✅ CORRECT - Allow overtime (quarter = 5)

```javascript
if (quarter >= 1 && quarter <= 5) {
  // Valid quarter (1-4 regular, 5 for OT)
}
```

---

## Implementation Guide

### Scraper Pseudocode (Not Yet Implemented)

```javascript
/**
 * Extract and upsert game drives
 */
async function extractGameDrives(gameSummary, gameId, season) {
  const drives = gameSummary.drives?.previous || []

  const driveRecords = drives.map((drive, index) => {
    const teamId = normalizeTeamId(drive.team.abbreviation)

    return {
      game_id: gameId,
      season: season,
      team_id: teamId,
      drive_number: index + 1,
      quarter: drive.start?.period?.number || null,
      start_time_seconds: parseClockToSeconds(drive.start?.clock?.displayValue),
      end_time_seconds: parseClockToSeconds(drive.end?.clock?.displayValue),
      duration_seconds: parseDuration(drive.timeElapsed?.displayValue),
      plays: drive.offensivePlays || 0,
      yards: drive.yards || 0,
      result: drive.displayResult || drive.result || null
    }
  })

  // Upsert to database
  const result = await upsertBatch(
    'game_drives',
    driveRecords,
    ['game_id', 'drive_number', 'team_id']
  )

  logger.info(`✓ Upserted ${result.success} drives for game ${gameId}`)
  return result
}

function parseClockToSeconds(clockDisplay) {
  if (!clockDisplay) return null
  const [minutes, seconds] = clockDisplay.split(':').map(Number)
  return (minutes * 60) + seconds
}

function parseDuration(durationDisplay) {
  if (!durationDisplay) return null
  const [minutes, seconds] = durationDisplay.split(':').map(Number)
  return (minutes * 60) + seconds
}
```

### Where to Add (game-stats-scraper.js)

**After line 300** (after extractGameRosters):

```javascript
// Extract and upsert game drives
await extractGameDrives(gameSummary, gameId, season)
```

---

## Frontend Display Examples

### Drive Chart

```jsx
const DriveChart = ({ gameId }) => {
  const { data: drives } = useQuery(() =>
    supabase
      .from('game_drives')
      .select(`
        *,
        team:teams(team_name, team_abbr, primary_color)
      `)
      .eq('game_id', gameId)
      .order('drive_number')
  )

  return (
    <div className="drive-chart">
      <h3>Drive Chart</h3>
      {drives?.map(drive => (
        <div
          key={drive.drive_id}
          className="drive-bar"
          style={{
            backgroundColor: drive.team.primary_color,
            width: `${(drive.yards / 100) * 100}%`
          }}
        >
          <span>{drive.team.team_abbr}</span>
          <span>{drive.plays} plays, {drive.yards} yds</span>
          <span className={`result ${drive.result.toLowerCase()}`}>
            {drive.result}
          </span>
        </div>
      ))}
    </div>
  )
}
```

### Drive Summary Stats

```jsx
const DriveSummary = ({ teamId, season }) => {
  const { data: drives } = useQuery(() =>
    supabase
      .from('game_drives')
      .select('*')
      .eq('team_id', teamId)
      .eq('season', season)
  )

  const stats = useMemo(() => {
    if (!drives) return null

    return {
      total: drives.length,
      avgPlays: (drives.reduce((sum, d) => sum + d.plays, 0) / drives.length).toFixed(1),
      avgYards: (drives.reduce((sum, d) => sum + d.yards, 0) / drives.length).toFixed(1),
      touchdowns: drives.filter(d => d.result === 'Touchdown').length,
      fieldGoals: drives.filter(d => d.result === 'Field Goal').length,
      turnovers: drives.filter(d => d.result === 'Turnover').length
    }
  }, [drives])

  return (
    <div className="drive-summary">
      <h4>Drive Efficiency</h4>
      <div className="stat">
        <label>Avg Plays:</label>
        <span>{stats?.avgPlays}</span>
      </div>
      <div className="stat">
        <label>Avg Yards:</label>
        <span>{stats?.avgYards}</span>
      </div>
      <div className="stat">
        <label>Scoring Drives:</label>
        <span>{stats?.touchdowns + stats?.fieldGoals} / {stats?.total}</span>
      </div>
    </div>
  )
}
```

---

## Validation Queries

### Check Data Completeness

```sql
-- Should have ~40-48 drives per game after scraper runs
SELECT
  game_id,
  COUNT(*) as drive_count,
  COUNT(DISTINCT team_id) as teams_with_drives
FROM game_drives
WHERE season = 2025
GROUP BY game_id
HAVING COUNT(*) < 30  -- Flag games with unusually few drives
ORDER BY drive_count;
```

### Verify Drive Results Distribution

```sql
-- Typical distribution: 40% Punt, 25% TD, 15% FG, 10% Turnover, 10% Other
SELECT
  result,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 1) as percentage
FROM game_drives
WHERE season = 2025
GROUP BY result
ORDER BY count DESC;
```

### Find Data Anomalies

```sql
-- Check for invalid data
SELECT *
FROM game_drives
WHERE
  plays > 20  -- Very long drive
  OR yards > 99  -- Max possible yards
  OR yards < 0  -- Negative yards (possible but unusual)
  OR duration_seconds > 900  -- Longer than a quarter
  OR quarter NOT BETWEEN 1 AND 5;
```

---

## Related Tables

### Referenced By

- `games` - Game information (FK: game_id)
- `teams` - Team details (FK: team_id)
- `play_by_play` - Individual plays within drive (FK: drive_id)

### Relationship Hierarchy

```
games
  └── game_drives (40-48 per game)
        └── play_by_play (10-15 plays per drive)
```

---

## Known Limitations

### 1. ESPN API May Have Incomplete Drive Data ⚠️

**Issue**: Some games may have incomplete or missing drive information.

**Impact**: Drive count may be lower than expected.

**Workaround**: Validate drive count and flag games with <30 drives for review.

---

### 2. Clock Time May Be Inaccurate ⚠️

**Issue**: ESPN clock times are game clock (not real-world time).

**Impact**: `duration_seconds` may not match actual real-world duration.

**Note**: `timeElapsed` is real-world duration, more accurate.

---

### 3. Drive Number May Not Be Sequential ⚠️

**Issue**: Kickoffs, penalties, and special situations may create gaps.

**Impact**: Drive numbers might skip (1, 2, 4, 5...).

**Solution**: Use array index + 1 for consistent numbering.

---

## Documentation Links

- **Field Mapping**: `GAME-DRIVES-RESOURCES/field-mapping-report.md` - All 11 fields documented
- **Raw Data Sources**: `GAME-DRIVES-RESOURCES/raw-data-source-mapping.md` - ESPN API structure
- **Database Schema**: `DATABASE-SCHEMA-REFERENCE.md` - Complete schema reference
- **Migration**: `supabase/migrations/20250101000008_create_game_and_reference_tables.sql` (lines 29-50)
- **Implementation**: To be added to `game-stats-scraper.js`

---

**Last Updated**: October 22, 2025
**Total Fields**: 11
**Total Records**: 0 (⚠️ Not yet scraped)
**Status**: ✅ Schema Complete, ❌ No Scraper
**CodeRef**: Migration 20250101000008:29-50 ✅ Validated
