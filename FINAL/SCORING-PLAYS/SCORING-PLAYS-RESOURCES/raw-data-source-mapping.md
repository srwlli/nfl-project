# Scoring Plays Table - Raw Data Source Mapping

> **Purpose**: Maps each database field to its raw ESPN API source
> **Date Generated**: October 22, 2025
> **Data Source**: ESPN API Game Summary (`scoringPlays` array)
> **CodeRef**: `extractScoringPlays` at game-stats-scraper.js:111-159

---

## Executive Summary

This document shows **exactly** where each field in the `scoring_plays` table comes from in the ESPN API response. All fields are extracted from the `scoringPlays` array in the game summary.

**Extraction Function**: Lines 111-159 of game-stats-scraper.js
**API Endpoint**: `https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event={gameId}`
**Data Path**: `response.scoringPlays[]`

---

## ESPN API Response Structure

### Primary Data Path

```javascript
{
  "scoringPlays": [
    {
      "id": "4017725100231",
      "type": {
        "text": "Touchdown"
      },
      "text": "Patrick Mahomes 15 yd pass to Travis Kelce (touchdown)",
      "awayScore": 14,
      "homeScore": 21,
      "period": {
        "number": 2
      },
      "clock": {
        "displayValue": "7:38"
      },
      "team": {
        "abbreviation": "KC"
      }
    }
  ]
}
```

---

## Field-by-Field Mapping (10 Fields)

### 1. scoring_play_id
- **Database Column**: `scoring_play_id`
- **Data Type**: SERIAL (auto-increment)
- **Raw Source**: Generated by database
- **API Path**: N/A
- **Transformation**: None
- **Example Raw**: N/A
- **Example Stored**: `1234`
- **Notes**: Primary key, auto-increments

---

### 2. game_id
- **Database Column**: `game_id`
- **Data Type**: VARCHAR(50)
- **Raw Source**: Function parameter
- **API Path**: N/A (passed to function)
- **Transformation**: Prefix with `"espn-"`
- **Example Raw**: `"401772510"`
- **Example Stored**: `"espn-401772510"`
- **Script**: game-stats-scraper.js line 148
- **Notes**: Cannot FK to partitioned games table

**Code**:
```javascript
return {
  game_id: `espn-${gameId}`,
  // ...
}
```

---

### 3. play_id
- **Database Column**: `play_id`
- **Data Type**: BIGINT
- **Raw Source**: ESPN scoring play ID
- **API Path**: `scoringPlays[].id`
- **Transformation**: parseInt() or null
- **Example Raw**: `"4017725100231"`
- **Example Stored**: `4017725100231`
- **Script**: game-stats-scraper.js line 149
- **Notes**: Nullable - not all plays have IDs

**Code**:
```javascript
play_id: play.id ? parseInt(play.id) : null,
```

---

### 4. season
- **Database Column**: `season`
- **Data Type**: INTEGER
- **Raw Source**: Global constant
- **API Path**: N/A (configured value)
- **Transformation**: None (direct)
- **Example Raw**: `2025`
- **Example Stored**: `2025`
- **Script**: game-stats-scraper.js line 150
- **Notes**: Part of composite key with game_id

**Code**:
```javascript
const SEASON_YEAR = 2025

return {
  season: SEASON_YEAR,
  // ...
}
```

---

### 5. team_id
- **Database Column**: `team_id`
- **Data Type**: VARCHAR(10)
- **Raw Source**: ESPN scoring play team
- **API Path**: `scoringPlays[].team.abbreviation`
- **Transformation**: Default to 'UNK' if missing
- **Example Raw**: `"KC"`
- **Example Stored**: `"KC"`
- **Script**: game-stats-scraper.js line 151
- **Notes**: Foreign key to teams table

**Code**:
```javascript
team_id: play.team?.abbreviation || 'UNK',
```

---

### 6. quarter
- **Database Column**: `quarter`
- **Data Type**: INTEGER
- **Raw Source**: ESPN period number
- **API Path**: `scoringPlays[].period.number`
- **Transformation**: Default to 1 if missing
- **Example Raw**: `2`
- **Example Stored**: `2`
- **Script**: game-stats-scraper.js line 152
- **Notes**: 1-4 for regulation, 5 for OT

**Code**:
```javascript
quarter: play.period?.number || 1,
```

---

### 7. time_remaining_seconds
- **Database Column**: `time_remaining_seconds`
- **Data Type**: INTEGER
- **Raw Source**: ESPN clock display
- **API Path**: `scoringPlays[].clock.displayValue`
- **Transformation**: parseClockToSeconds() - converts MM:SS to seconds
- **Example Raw**: `"7:38"`
- **Example Stored**: `458` (7 * 60 + 38)
- **Script**: game-stats-scraper.js line 153, 164-171
- **Notes**: Nullable for some plays

**Code**:
```javascript
time_remaining_seconds: parseClockToSeconds(play.clock?.displayValue)

// Helper function (lines 164-171)
function parseClockToSeconds(clockStr) {
  if (!clockStr || typeof clockStr !== 'string') return null
  const parts = clockStr.split(':')
  if (parts.length !== 2) return null
  const minutes = parseInt(parts[0])
  const seconds = parseInt(parts[1])
  return minutes * 60 + seconds
}
```

**Conversion Examples**:
- `"7:38"` → `458` seconds
- `"0:15"` → `15` seconds
- `"14:52"` → `892` seconds

---

### 8. scoring_type
- **Database Column**: `scoring_type`
- **Data Type**: VARCHAR(50)
- **Raw Source**: ESPN play type text
- **API Path**: `scoringPlays[].type.text`
- **Transformation**: Default to 'unknown' if missing
- **Example Raw**: `"Touchdown"`
- **Example Stored**: `"Touchdown"`
- **Script**: game-stats-scraper.js line 154
- **Notes**: Values include "Touchdown", "Field Goal", "Extra Point", "Two-Point Conversion", "Safety"

**Code**:
```javascript
scoring_type: play.type?.text || 'unknown',
```

**Possible Values from ESPN**:
- "Touchdown"
- "Field Goal"
- "Extra Point"
- "Two-Point Conversion"
- "Safety"

---

### 9. points
- **Database Column**: `points`
- **Data Type**: INTEGER
- **Raw Source**: CALCULATED from score difference
- **API Path**: `scoringPlays[].awayScore` and `scoringPlays[].homeScore`
- **Transformation**: Complex calculation (see below)
- **Example Raw**: `awayScore: 14, homeScore: 21` (and previous play scores)
- **Example Stored**: `7` (touchdown + extra point)
- **Script**: game-stats-scraper.js lines 115-145
- **Notes**: Calculated by comparing current score to previous play's score

**Calculation Logic** (lines 115-145):

```javascript
let points = 0

if (index > 0) {
  // Not first play - compare to previous play
  const prevPlay = scoringPlays[index - 1]

  // Determine if this team is home or away
  const competition = gameSummary.header?.competitions?.[0]
  const isAway = competition?.competitors?.find(
    c => c.team?.abbreviation === play.team.abbreviation
  )?.homeAway === 'away'

  if (play.team.abbreviation === prevPlay.team.abbreviation) {
    // Same team scored twice in a row
    if (isAway) {
      points = play.awayScore - prevPlay.awayScore
    } else {
      points = play.homeScore - prevPlay.homeScore
    }
  } else {
    // Different team - get their score vs previous total
    if (isAway) {
      points = play.awayScore - (prevPlay.awayScore || 0)
    } else {
      points = play.homeScore - (prevPlay.homeScore || 0)
    }
  }
} else {
  // First scoring play - points = current score
  const competition = gameSummary.header?.competitions?.[0]
  const isAway = competition?.competitors?.find(
    c => c.team?.abbreviation === play.team.abbreviation
  )?.homeAway === 'away'

  points = isAway ? play.awayScore : play.homeScore
}
```

**Why This Complexity?**
ESPN doesn't provide points directly. We calculate by:
1. Check if first play → points = team's current score
2. Check if same team as previous → delta between scores
3. Check if different team → their new score minus their old score

**Examples**:
```
Play 1: KC scores, awayScore: 7, homeScore: 0
→ points = 7 (first play, away team)

Play 2: KC scores again, awayScore: 14, homeScore: 0
→ points = 14 - 7 = 7

Play 3: DEN scores, awayScore: 14, homeScore: 7
→ points = 7 - 0 = 7 (home team's first score)
```

---

### 10. description
- **Database Column**: `description`
- **Data Type**: TEXT
- **Raw Source**: ESPN play text description
- **API Path**: `scoringPlays[].text`
- **Transformation**: Default to empty string if missing
- **Example Raw**: `"Patrick Mahomes 15 yd pass to Travis Kelce (touchdown)"`
- **Example Stored**: `"Patrick Mahomes 15 yd pass to Travis Kelce (touchdown)"`
- **Script**: game-stats-scraper.js line 156
- **Notes**: Human-readable play description

**Code**:
```javascript
description: play.text || ''
```

**Description Format Examples**:
- Touchdown: `"Patrick Mahomes 15 yd pass to Travis Kelce (touchdown)"`
- Field Goal: `"Harrison Butker 47 yd field goal"`
- Extra Point: `"Harrison Butker extra point"`
- Safety: `"DeAngelo Hall tackled Patrick Mahomes in end zone for a Safety"`

---

### 11-13. Metadata (created_at, updated_at, deleted_at)
- **Database Columns**: `created_at`, `updated_at`, `deleted_at`
- **Data Type**: TIMESTAMP
- **Raw Source**: Database triggers
- **API Path**: N/A
- **Transformation**: None
- **Example Raw**: N/A
- **Example Stored**: `"2025-10-20T16:30:00Z"`
- **Notes**: Managed by database automatically

---

## Complete ESPN API Response Example

### Request
```
GET https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=401772510
```

### Response (Scoring Plays Section)
```json
{
  "scoringPlays": [
    {
      "id": "4017725100021",
      "type": {
        "id": "68",
        "text": "Touchdown",
        "abbreviation": "TD"
      },
      "text": "Isiah Pacheco 5 yd run (Harrison Butker kick)",
      "awayScore": 7,
      "homeScore": 0,
      "period": {
        "number": 1,
        "type": {
          "id": "1",
          "text": "1st Quarter"
        }
      },
      "clock": {
        "displayValue": "8:23",
        "value": 503
      },
      "scoringPlay": true,
      "team": {
        "id": "12",
        "uid": "s:20~l:28~t:12",
        "abbreviation": "KC",
        "displayName": "Kansas City Chiefs",
        "shortDisplayName": "Chiefs",
        "logos": [
          {
            "href": "https://a.espncdn.com/i/teamlogos/nfl/500/kc.png"
          }
        ]
      },
      "participants": [
        {
          "athlete": {
            "id": "4361741",
            "fullName": "Isiah Pacheco"
          }
        }
      ]
    },
    {
      "id": "4017725100052",
      "type": {
        "id": "59",
        "text": "Field Goal",
        "abbreviation": "FG"
      },
      "text": "Wil Lutz 34 yd field goal",
      "awayScore": 7,
      "homeScore": 3,
      "period": {
        "number": 1
      },
      "clock": {
        "displayValue": "2:15",
        "value": 135
      },
      "team": {
        "id": "7",
        "abbreviation": "DEN"
      }
    }
  ]
}
```

---

## Data Extraction Workflow

### Step 1: Fetch Game Summary
```javascript
const espnId = gameId.replace('espn-', '')
const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${espnId}`
const response = await fetch(url)
const gameSummary = await response.json()
```

### Step 2: Extract Scoring Plays
```javascript
const scoringPlays = extractScoringPlays(gameSummary, espnId)
// Returns array of scoring play objects
```

### Step 3: Delete Existing & Insert New
```javascript
// Delete existing scoring plays for this game (allows re-scraping)
await supabase
  .from('scoring_plays')
  .delete()
  .eq('game_id', `espn-${gameId}`)

// Insert new records
const result = await insertBatch('scoring_plays', scoringPlays)
```

---

## Common Data Issues

### Issue 1: Missing Clock Value
**Symptom**: `time_remaining_seconds` is NULL
**Cause**: ESPN doesn't always provide clock for older games
**Solution**: Field is nullable, frontend should handle NULL gracefully

### Issue 2: First Play Points Calculation
**Symptom**: First scoring play might show incorrect points
**Cause**: No previous play to compare against
**Solution**: Use team's current score as points (lines 140-144)

### Issue 3: Duplicate Scoring Plays on Re-scrape
**Symptom**: Multiple entries for same play
**Cause**: No unique constraint on table
**Solution**: Script deletes existing plays before inserting (line 668)

---

## Additional ESPN Data Available (Not Currently Used)

The ESPN scoringPlays array includes more data that could be added:

```javascript
{
  "participants": [
    {
      "athlete": {
        "id": "4361741",
        "fullName": "Isiah Pacheco",
        "shortName": "I. Pacheco"
      }
    }
  ],
  "type": {
    "id": "68",
    "abbreviation": "TD"
  },
  "scoringPlayId": "4017725100021"
}
```

### Potential Future Enhancements
1. Add `player_id` column (from participants[].athlete.id)
2. Add `scoring_play_type_id` (from type.id)
3. Add link to play_by_play table for EPA/WPA data

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-10-01 | Initial scoring_plays extraction |
| 1.1 | 2025-10-22 | Documentation created with CodeRef |

---

## References

- **Scraper**: `scripts/scrapers/game-stats-scraper.js` (lines 111-159)
- **CodeRef Location**: `extractScoringPlays:111`
- **ESPN API Docs**: Not publicly documented (reverse-engineered)
- **Migration**: `supabase/migrations/20250101000008_create_game_and_reference_tables.sql` (lines 99-119)

---

**Last Updated**: October 22, 2025
**Data Source**: ESPN API Game Summary (scoringPlays array)
**Total Fields**: 10 (9 from ESPN + 1 database)
**Automation**: ✅ Fully automated via live-games-scraper → game-stats-scraper
**CodeRef Validation**: ✅ All fields match between code:111-159 and schema:99-119
