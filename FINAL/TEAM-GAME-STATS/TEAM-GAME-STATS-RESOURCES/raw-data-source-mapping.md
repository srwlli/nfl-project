# Team Game Stats Table - Raw Data Source Mapping

> **Purpose**: Complete field-by-field mapping from ESPN API to team_game_stats table
> **Date Generated**: October 22, 2025
> **Status**: âœ… All 13 fields mapped

---

## Executive Summary

This document shows **exactly** where each field in the `team_game_stats` table comes from in the ESPN API response. Use this when:
- Debugging data extraction issues
- Understanding transformation logic
- Adding new fields
- Troubleshooting missing data

**Data Source**: ESPN Game Summary API
**Endpoint**: `https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event={gameId}`
**Extraction Function**: `extractTeamStats(gameSummary, gameId)` in `scripts/scrapers/game-stats-scraper.js` (lines 44-93)

---

## ESPN API Response Structure

### Primary Data Paths

```javascript
{
  "header": {
    "competitions": [
      {
        "competitors": [
          {
            "id": "23",
            "team": {
              "abbreviation": "PIT"
            },
            "homeAway": "home",
            "score": "28"
          },
          {
            "id": "4",
            "team": {
              "abbreviation": "CIN"
            },
            "homeAway": "away",
            "score": "24"
          }
        ]
      }
    ]
  },
  "boxscore": {
    "teams": [
      {
        "team": {
          "id": "23",
          "abbreviation": "PIT",
          "displayName": "Pittsburgh Steelers"
        },
        "statistics": [
          {
            "name": "totalYards",
            "displayValue": "385",
            "value": 385
          },
          {
            "name": "turnovers",
            "displayValue": "2",
            "value": 2
          },
          {
            "name": "possessionTime",
            "displayValue": "30:45",
            "value": "30:45"
          }
        ]
      }
    ]
  }
}
```

---

## Field-by-Field Mapping (13 Fields)

### 1. team_game_stat_id
- **Database Column**: `team_game_stat_id`
- **Data Type**: SERIAL (auto-increment)
- **Raw Source**: Generated by database
- **API Path**: N/A
- **Transformation**: None
- **Example Raw**: N/A
- **Example Stored**: `1234`
- **Notes**: Primary key, auto-increments

---

### 2. team_id
- **Database Column**: `team_id`
- **Data Type**: VARCHAR(10)
- **Raw Source**: ESPN boxscore team abbreviation
- **API Path**: `boxscore.teams[].team.abbreviation`
- **Transformation**: None
- **Example Raw**: `"PIT"`
- **Example Stored**: `"PIT"`
- **Script**: `game-stats-scraper.js` line 65, 80
- **Notes**: Foreign key to teams table

**Code**:
```javascript
const teamAbbr = teamData.team.abbreviation
return {
  team_id: teamAbbr,
  // ...
}
```

---

### 3. game_id
- **Database Column**: `game_id`
- **Data Type**: VARCHAR(50)
- **Raw Source**: ESPN game ID (prefixed)
- **API Path**: Function parameter `gameId`
- **Transformation**: Prefix with `"espn-"`
- **Example Raw**: `"401772510"`
- **Example Stored**: `"espn-401772510"`
- **Script**: `game-stats-scraper.js` line 81
- **Notes**: Cannot FK to partitioned games table

**Code**:
```javascript
game_id: `espn-${gameId}`,
```

---

### 4. season
- **Database Column**: `season`
- **Data Type**: INTEGER
- **Raw Source**: Script constant
- **API Path**: N/A (hardcoded)
- **Transformation**: None
- **Example Raw**: `2025`
- **Example Stored**: `2025`
- **Script**: `game-stats-scraper.js` line 14, 82
- **Notes**: Part of composite key with game_id

**Code**:
```javascript
const SEASON_YEAR = 2025

return {
  season: SEASON_YEAR,
  // ...
}
```

---

### 5. is_home
- **Database Column**: `is_home`
- **Data Type**: BOOLEAN
- **Raw Source**: Comparison of team abbreviation to home team
- **API Path**: `header.competitions[0].competitors[homeAway="home"].team.abbreviation`
- **Transformation**: Boolean comparison
- **Example Raw**: `"PIT" === "PIT"`
- **Example Stored**: `true`
- **Script**: `game-stats-scraper.js` lines 52, 66
- **Notes**: Determines home/away status

**Code**:
```javascript
const homeTeam = competition?.competitors?.find(c => c.homeAway === 'home')
const teamAbbr = teamData.team.abbreviation
const isHome = teamAbbr === homeTeam?.team?.abbreviation

return {
  is_home: isHome,
  // ...
}
```

---

### 6. points_scored
- **Database Column**: `points_scored`
- **Data Type**: INTEGER
- **Raw Source**: Team's score from competition data
- **API Path**: `header.competitions[0].competitors[].score` (matching team)
- **Transformation**: parseInt()
- **Example Raw**: `"28"`
- **Example Stored**: `28`
- **Script**: `game-stats-scraper.js` lines 69-70, 84
- **Notes**: Uses competitor data, not boxscore statistics

**Code**:
```javascript
// Get scores from competition data
const teamCompetitor = isHome ? homeTeam : awayTeam
const opponentCompetitor = isHome ? awayTeam : homeTeam

return {
  points_scored: teamCompetitor?.score ? parseInt(teamCompetitor.score) : 0,
  // ...
}
```

---

### 7. points_allowed
- **Database Column**: `points_allowed`
- **Data Type**: INTEGER
- **Raw Source**: Opponent's score from competition data
- **API Path**: `header.competitions[0].competitors[].score` (opponent)
- **Transformation**: parseInt()
- **Example Raw**: `"24"`
- **Example Stored**: `24`
- **Script**: `game-stats-scraper.js` line 85
- **Notes**: Automatically calculated from opponent's score

**Code**:
```javascript
const opponentCompetitor = isHome ? awayTeam : homeTeam

return {
  points_allowed: opponentCompetitor?.score ? parseInt(opponentCompetitor.score) : 0,
  // ...
}
```

---

### 8. total_yards
- **Database Column**: `total_yards`
- **Data Type**: DECIMAL(6,1)
- **Raw Source**: ESPN boxscore totalYards statistic
- **API Path**: `boxscore.teams[].statistics[name="totalYards"].displayValue`
- **Transformation**: parseNumber() - handles "-", null, empty strings
- **Example Raw**: `"385"` or `"-"`
- **Example Stored**: `385.0`
- **Script**: `game-stats-scraper.js` lines 56-63, 73-77, 86
- **Notes**: Passing yards + rushing yards combined

**Code**:
```javascript
// Convert array of stats to key-value map
const statMap = {}
stats.forEach(stat => {
  statMap[stat.name] = stat.displayValue || stat.value
})

// Helper function to safely parse numbers
const parseNumber = (value) => {
  if (value === null || value === undefined || value === '' || value === '-') return 0
  const num = parseFloat(value)
  return isNaN(num) ? 0 : num
}

return {
  total_yards: parseNumber(statMap.totalYards),
  // ...
}
```

**ESPN Boxscore Statistics Available**:
```javascript
boxscore.teams[].statistics = [
  { name: "totalYards", displayValue: "385", value: 385 },
  { name: "turnovers", displayValue: "2", value: 2 },
  { name: "possessionTime", displayValue: "30:45", value: "30:45" },
  { name: "firstDowns", displayValue: "24", value: 24 },
  { name: "thirdDownEff", displayValue: "7-14", value: "7-14" },
  { name: "fourthDownEff", displayValue: "1-2", value: "1-2" },
  { name: "passingYards", displayValue: "225", value: 225 },
  { name: "rushingYards", displayValue: "160", value: 160 },
  { name: "penalties", displayValue: "5-45", value: "5-45" },
  // ... more stats available
]
```

---

### 9. total_yards_allowed
- **Database Column**: `total_yards_allowed`
- **Data Type**: DECIMAL(6,1)
- **Raw Source**: NOT IMPLEMENTED (would be opponent's totalYards)
- **API Path**: Would require matching opponent team's statistics
- **Transformation**: N/A
- **Example Raw**: N/A
- **Example Stored**: `0` (hardcoded)
- **Script**: `game-stats-scraper.js` line 87
- **Notes**: Always 0, needs enhancement to calculate from opponent

**Code**:
```javascript
return {
  total_yards_allowed: 0, // Will need opponent's stats to calculate
  // ...
}
```

**Known Limitation**: Currently hardcoded to 0. To implement:
1. After extracting both teams' stats
2. Match each team's `total_yards` to opponent's `total_yards_allowed`
3. Update both records

---

### 10. turnovers
- **Database Column**: `turnovers`
- **Data Type**: INTEGER
- **Raw Source**: ESPN boxscore turnovers statistic
- **API Path**: `boxscore.teams[].statistics[name="turnovers"].displayValue`
- **Transformation**: parseNumber()
- **Example Raw**: `"2"`
- **Example Stored**: `2`
- **Script**: `game-stats-scraper.js` line 88
- **Notes**: Interceptions thrown + fumbles lost

**Code**:
```javascript
return {
  turnovers: parseNumber(statMap.turnovers),
  // ...
}
```

---

### 11. turnovers_forced
- **Database Column**: `turnovers_forced`
- **Data Type**: INTEGER
- **Raw Source**: NOT IMPLEMENTED (would be opponent's turnovers)
- **API Path**: Would require opponent team's turnovers statistic
- **Transformation**: N/A
- **Example Raw**: N/A
- **Example Stored**: `0` (hardcoded)
- **Script**: `game-stats-scraper.js` line 89
- **Notes**: Always 0, needs enhancement

**Code**:
```javascript
return {
  turnovers_forced: 0, // Will need opponent's turnovers
  // ...
}
```

**Known Limitation**: Currently hardcoded to 0. To implement:
1. After extracting both teams' stats
2. Match each team's `turnovers` to opponent's `turnovers_forced`
3. Update both records

---

### 12. time_of_possession_seconds
- **Database Column**: `time_of_possession_seconds`
- **Data Type**: INTEGER
- **Raw Source**: ESPN boxscore possessionTime statistic
- **API Path**: `boxscore.teams[].statistics[name="possessionTime"].displayValue`
- **Transformation**: parseTimeToSeconds() - converts MM:SS to seconds
- **Example Raw**: `"30:45"`
- **Example Stored**: `1845` (30*60 + 45)
- **Script**: `game-stats-scraper.js` line 90, utility function in file
- **Notes**: Can be NULL for some games

**Code**:
```javascript
// Utility function (defined elsewhere in file)
function parseTimeToSeconds(timeStr) {
  if (!timeStr || timeStr === '-') return null
  const parts = timeStr.split(':')
  if (parts.length !== 2) return null
  const minutes = parseInt(parts[0])
  const seconds = parseInt(parts[1])
  if (isNaN(minutes) || isNaN(seconds)) return null
  return minutes * 60 + seconds
}

return {
  time_of_possession_seconds: parseTimeToSeconds(statMap.possessionTime)
  // ...
}
```

**Conversion Examples**:
- `"30:45"` â†’ `1845` seconds
- `"25:30"` â†’ `1530` seconds
- `"-"` â†’ `null`
- `""` â†’ `null`

---

### 13. created_at, updated_at, deleted_at (Metadata)
- **Database Columns**: `created_at`, `updated_at`, `deleted_at`
- **Data Type**: TIMESTAMP
- **Raw Source**: Database triggers
- **API Path**: N/A
- **Transformation**: None
- **Example Raw**: N/A
- **Example Stored**: `"2025-10-20T16:30:00Z"`
- **Notes**: Managed by database
  - `created_at`: Set on INSERT
  - `updated_at`: Set on INSERT and UPDATE
  - `deleted_at`: Set on soft delete (default NULL)

---

## Complete ESPN API Response Example

### Request
```
GET https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=401772510
```

### Response (Relevant Sections)
```json
{
  "header": {
    "id": "401772510",
    "season": {
      "year": 2025
    },
    "competitions": [
      {
        "id": "401772510",
        "competitors": [
          {
            "id": "23",
            "team": {
              "id": "23",
              "abbreviation": "PIT",
              "displayName": "Pittsburgh Steelers"
            },
            "homeAway": "home",
            "score": "28",
            "winner": true
          },
          {
            "id": "4",
            "team": {
              "id": "4",
              "abbreviation": "CIN",
              "displayName": "Cincinnati Bengals"
            },
            "homeAway": "away",
            "score": "24",
            "winner": false
          }
        ]
      }
    ]
  },
  "boxscore": {
    "teams": [
      {
        "team": {
          "id": "23",
          "abbreviation": "PIT",
          "displayName": "Pittsburgh Steelers",
          "logo": "https://a.espncdn.com/i/teamlogos/nfl/500/pit.png"
        },
        "statistics": [
          {
            "name": "totalYards",
            "displayValue": "385",
            "label": "Total Yards",
            "abbreviation": "YDS"
          },
          {
            "name": "turnovers",
            "displayValue": "2",
            "label": "Turnovers"
          },
          {
            "name": "possessionTime",
            "displayValue": "30:45",
            "label": "Possession"
          },
          {
            "name": "firstDowns",
            "displayValue": "24",
            "label": "First Downs"
          },
          {
            "name": "thirdDownEff",
            "displayValue": "7-14",
            "label": "Third Down Efficiency"
          },
          {
            "name": "fourthDownEff",
            "displayValue": "1-2",
            "label": "Fourth Down Efficiency"
          },
          {
            "name": "passingYards",
            "displayValue": "225",
            "label": "Passing Yards"
          },
          {
            "name": "rushingYards",
            "displayValue": "160",
            "label": "Rushing Yards"
          },
          {
            "name": "penalties",
            "displayValue": "5-45",
            "label": "Penalties-Yards"
          }
        ]
      },
      {
        "team": {
          "id": "4",
          "abbreviation": "CIN",
          "displayName": "Cincinnati Bengals",
          "logo": "https://a.espncdn.com/i/teamlogos/nfl/500/cin.png"
        },
        "statistics": [
          {
            "name": "totalYards",
            "displayValue": "342",
            "label": "Total Yards"
          },
          {
            "name": "turnovers",
            "displayValue": "1",
            "label": "Turnovers"
          },
          {
            "name": "possessionTime",
            "displayValue": "29:15",
            "label": "Possession"
          }
          // ... more stats
        ]
      }
    ]
  }
}
```

---

## Data Extraction Workflow

### Step 1: Fetch Game Summary
```javascript
const espnId = gameId.replace('espn-', '')
const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${espnId}`
const response = await fetch(url)
const gameSummary = await response.json()
```

### Step 2: Extract Team Stats
```javascript
const teamStats = extractTeamStats(gameSummary, espnId)
// Returns array of 2 team stat objects (home + away)
```

### Step 3: Upsert to Database
```javascript
const result = await upsertBatch(
  'team_game_stats',
  teamStats,
  ['team_id', 'game_id']
)
```

---

## Transformation Functions

### parseNumber()
```javascript
const parseNumber = (value) => {
  if (value === null || value === undefined || value === '' || value === '-') return 0
  const num = parseFloat(value)
  return isNaN(num) ? 0 : num
}
```

**Purpose**: Safely parse numeric stats
**Handles**: null, undefined, empty string, "-" (ESPN's "no data" indicator)
**Returns**: Number or 0

### parseTimeToSeconds()
```javascript
function parseTimeToSeconds(timeStr) {
  if (!timeStr || timeStr === '-') return null
  const parts = timeStr.split(':')
  if (parts.length !== 2) return null
  const minutes = parseInt(parts[0])
  const seconds = parseInt(parts[1])
  if (isNaN(minutes) || isNaN(seconds)) return null
  return minutes * 60 + seconds
}
```

**Purpose**: Convert MM:SS to total seconds
**Input**: `"30:45"`
**Output**: `1845`
**Returns**: Number or null

---

## Common Data Issues

### Issue 1: Missing Boxscore Data
**Symptom**: No team stats extracted for completed game
**Cause**: ESPN API hasn't updated with boxscore yet
**Solution**: Retry scraper later (usually within 15-30 minutes after game ends)

### Issue 2: "-" Values
**Symptom**: Some stats show as "-" string
**Cause**: ESPN uses "-" for unavailable data
**Solution**: parseNumber() handles this, returns 0

### Issue 3: Yards Allowed Always 0
**Symptom**: `total_yards_allowed` is always 0
**Cause**: Not implemented (requires opponent lookup)
**Solution**: Known limitation, documented in field-mapping-report.md

### Issue 4: Turnovers Forced Always 0
**Symptom**: `turnovers_forced` is always 0
**Cause**: Not implemented (requires opponent lookup)
**Solution**: Known limitation, documented in field-mapping-report.md

---

## Additional ESPN Statistics Available (Not Currently Used)

The ESPN boxscore includes many more statistics that could be added:

```javascript
{
  "name": "firstDowns",
  "displayValue": "24"
},
{
  "name": "thirdDownEff",
  "displayValue": "7-14"  // 7 conversions of 14 attempts
},
{
  "name": "fourthDownEff",
  "displayValue": "1-2"
},
{
  "name": "passingYards",
  "displayValue": "225"
},
{
  "name": "rushingYards",
  "displayValue": "160"
},
{
  "name": "penalties",
  "displayValue": "5-45"  // 5 penalties for 45 yards
},
{
  "name": "completionAttempts",
  "displayValue": "18-28"
},
{
  "name": "yardsPerPass",
  "displayValue": "8.0"
},
{
  "name": "rushingAttempts",
  "displayValue": "32"
},
{
  "name": "yardsPerRushAttempt",
  "displayValue": "5.0"
},
{
  "name": "redZoneAttempts",
  "displayValue": "4-5"  // 4 scores of 5 attempts
},
{
  "name": "sacks",
  "displayValue": "3-18"  // 3 sacks for 18 yards
},
{
  "name": "interceptions",
  "displayValue": "1"
},
{
  "name": "fumblesLost",
  "displayValue": "1"
}
```

### Potential Future Enhancements
1. Add passing/rushing yard breakdown (already available)
2. Add first downs tracking
3. Add third/fourth down conversion rates
4. Add penalty tracking
5. Add sacks allowed
6. Implement `total_yards_allowed` calculation
7. Implement `turnovers_forced` calculation

---

## Script Usage Examples

### Extract Team Stats for Specific Game
```bash
# Single game
npm run scrape:game-stats -- --game=401772510

# The script will:
# 1. Fetch game summary from ESPN
# 2. Extract team stats for both teams
# 3. Upsert 2 records to team_game_stats table
```

### Extract Team Stats for Entire Week
```bash
# All games in week 7
npm run scrape:game-stats -- --week=7

# The script will:
# 1. Fetch all games for the week from database
# 2. Process each completed game
# 3. Extract team stats for home + away
# 4. Upsert all records in batches
```

---

## Validation Queries

### Check Team Stats for Game
```sql
SELECT
  tgs.*,
  t.team_name,
  g.game_date,
  g.status
FROM team_game_stats tgs
JOIN teams t ON tgs.team_id = t.team_id
JOIN games g ON tgs.game_id = g.game_id AND tgs.season = g.season
WHERE tgs.game_id = 'espn-401772510'
  AND tgs.season = 2025
ORDER BY tgs.is_home DESC;
```

### Verify Data Completeness
```sql
-- Count team stats vs completed games
SELECT
  'Completed Games' AS type,
  COUNT(*) AS count
FROM games
WHERE season = 2025
  AND status = 'final'

UNION ALL

SELECT
  'Team Stats Records' AS type,
  COUNT(*) AS count
FROM team_game_stats
WHERE season = 2025;

-- Should be: Team Stats = Completed Games Ã— 2
```

### Check for Missing Stats
```sql
-- Games that have no team stats
SELECT
  g.game_id,
  g.week,
  g.game_date,
  g.home_team_id,
  g.away_team_id
FROM games g
LEFT JOIN team_game_stats tgs
  ON g.game_id = tgs.game_id
  AND g.season = tgs.season
WHERE g.season = 2025
  AND g.status = 'final'
  AND tgs.team_game_stat_id IS NULL;
```

---

## Troubleshooting Guide

### Problem: No team stats for completed game
**Check**: Did game just finish?
```sql
SELECT game_id, status, game_date
FROM games
WHERE game_id = 'espn-401772510';
```

**Solution**: Wait 15-30 minutes after game ends, then re-run scraper

### Problem: Yards/turnovers showing as 0
**Check**: Is boxscore data available?
```bash
# Check ESPN API directly
curl "https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=401772510" \
  | jq '.boxscore.teams[].statistics'
```

**Solution**: If API shows "-", data not available yet. Retry later.

### Problem: Time of possession is NULL
**Check**: ESPN may not provide possession time for all games
**Solution**: This is normal, NULL is acceptable

---

## Related Documentation

- **Field Mapping**: `field-mapping-report.md` - Complete 13-field breakdown
- **Quick Reference**: `my-guide.md` - Copy-paste field lists and queries
- **Script**: `scripts/game-stats-scraper.js` - Extraction implementation
- **Migration**: `supabase/migrations/20250101000007_create_team_stats_tables.sql` - Table schema
- **Database Schema**: `DATABASE-SCHEMA-REFERENCE.md` - Complete schema reference

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-10-01 | Initial team_game_stats extraction implemented |
| 1.1 | 2025-10-22 | Documentation created |

---

**Last Updated**: October 22, 2025
**Status**: âœ… All 13 fields mapped
**Known Limitations**: 2 fields hardcoded to 0 (yards_allowed, turnovers_forced)
